services:
  bitcoind:
    image: ruimarinho/bitcoin-core:24.0.1
    command:
      - "-regtest=1"
      - "-server=1"
      - "-txindex=1"
      - "-fallbackfee=0.0002"
      - "-rpcuser=rpcuser"
      - "-rpcpassword=rpcpass"
      - "-rpcbind=0.0.0.0:18443"
      - "-rpcallowip=0.0.0.0/0"
      - "-printtoconsole"
      - "-zmqpubrawblock=tcp://0.0.0.0:28332"
      - "-zmqpubrawtx=tcp://0.0.0.0:28333"
    ports:
      - "18443:18443"
      - "18444:18444"
      - "28332:28332"
      - "28333:28333"
    volumes:
      - bitcoind_datadir:/bitcoin/.bitcoin

  cln-alice:
    image: elementsproject/lightningd:v24.02.2
    depends_on:
      - bitcoind
    environment:
      # The image entrypoint waits for lightning-rpc under $LIGHTNINGD_DATA/$LIGHTNINGD_NETWORK.
      # If LIGHTNINGD_NETWORK is left at its default ("bitcoin"), the entrypoint watches the wrong
      # directory even if we pass --network=regtest.
      - LIGHTNINGD_NETWORK=regtest
    command:
      - "--alias=alice"
      - "--network=regtest"
      - "--log-level=debug"
      - "--bind-addr=0.0.0.0:9735"
      - "--bitcoin-rpcconnect=bitcoind"
      - "--bitcoin-rpcport=18443"
      - "--bitcoin-rpcuser=rpcuser"
      - "--bitcoin-rpcpassword=rpcpass"
      - "--bitcoin-retry-timeout=60"
      - "--developer"
    ports:
      - "9735:9735"
    volumes:
      # Mount the network data dir directly so it exists before the entrypoint's inotifywait runs.
      - cln_alice_datadir:/root/.lightning/regtest

  cln-bob:
    image: elementsproject/lightningd:v24.02.2
    depends_on:
      - bitcoind
    environment:
      - LIGHTNINGD_NETWORK=regtest
    command:
      - "--alias=bob"
      - "--network=regtest"
      - "--log-level=debug"
      - "--bind-addr=0.0.0.0:9735"
      - "--bitcoin-rpcconnect=bitcoind"
      - "--bitcoin-rpcport=18443"
      - "--bitcoin-rpcuser=rpcuser"
      - "--bitcoin-rpcpassword=rpcpass"
      - "--bitcoin-retry-timeout=60"
      - "--developer"
    ports:
      - "9736:9735"
    volumes:
      - cln_bob_datadir:/root/.lightning/regtest

volumes:
  bitcoind_datadir: {}
  cln_alice_datadir: {}
  cln_bob_datadir: {}
